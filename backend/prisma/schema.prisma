generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model usuarios {
  id         Int         @id @default(autoincrement())
  nome       String      @db.VarChar(255)
  email      String      @unique @db.VarChar(255)
  senha_hash String      @db.VarChar(255)
  created_at DateTime?   @default(now()) @db.Timestamptz(6)
  celulares  celulares[]
  pecas      pecas[]
  movimentacoes movimentacoes_estoque[]
}

model clientes {
  id            Int          @id @default(autoincrement())
  nome          String       @db.VarChar(255)
  cpf           String       @unique @db.VarChar(255)
  telefone      String?      @db.VarChar(255)
  email         String?      @db.VarChar(255)
  tipo          TipoCliente  @default(CONSUMIDOR)
  data_cadastro DateTime?    @default(now()) @db.Timestamptz(6)

  ordens_servico ordens_servico[]
  vendas         vendas[]
  garantias      garantias[]
}

model celulares {
  id                     Int       @id @default(autoincrement())
  modelo                 String    @db.VarChar(255)
  imei                   String    @unique @db.VarChar(255)
  cor                    String?   @db.VarChar(255)
  capacidade             String?   @db.VarChar(255)
  valor_compra           Decimal?  @db.Decimal(10, 2)
  garantia_padrao_dias   Int       @default(365)
  defeitos_identificados String?
  tipo                   TipoEstoqueCelular
  status                 StatusCelular @default(EmEstoque)
  data_cadastro          DateTime? @default(now()) @db.Timestamptz(6)
  nome_fornecedor        String    @db.VarChar(255)
  usuario_cadastro_id    Int?
  usuario_cadastro       usuarios? @relation(fields: [usuario_cadastro_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  created_by             Int?      @default(1)
  updated_by             Int?      @default(1)
  updated_at             DateTime? @db.Timestamptz(6)

  ordens_servico ordens_servico[]
  historico       celulares_historico[]
  vendas          vendas[]
  movimentacoes   movimentacoes_estoque[]
  garantias       garantias[]
}

model pecas {
  id                   Int       @id @default(autoincrement())
  nome                 String    @db.VarChar(255)
  codigo_interno       String    @unique @db.VarChar(255)
  compatibilidade      String?
  quantidade           Int       @default(0)
  garantia_padrao_dias Int       @default(90)
  data_cadastro        DateTime? @default(now()) @db.Timestamptz(6)
  nome_fornecedor      String    @db.VarChar(255)
  usuario_cadastro_id  Int?
  usuario_cadastro     usuarios? @relation(fields: [usuario_cadastro_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  created_by           Int?      @default(1)
  updated_by           Int?      @default(1)
  updated_at           DateTime? @db.Timestamptz(6)

  ordens_servico_usos ordens_servico_pecas[]
  movimentacoes       movimentacoes_estoque[]
}

model ordens_servico {
  id                Int                 @id @default(autoincrement())
  cliente_id        Int
  celular_id        Int
  descricao         String?             @db.Text
  status            StatusOrdemServico  @default(EmAndamento)
  data_abertura     DateTime?           @default(now()) @db.Timestamptz(6)
  data_conclusao    DateTime?           @db.Timestamptz(6)
  garantia_dias     Int?
  garantia_validade DateTime?           @db.Timestamptz(6)
  observacoes       String?             @db.Text
  created_by        Int?                @default(1)
  updated_by        Int?                @default(1)
  updated_at        DateTime?           @db.Timestamptz(6)

  cliente clientes @relation(fields: [cliente_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  celular celulares @relation(fields: [celular_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  historico celulares_historico[]
  pecas_utilizadas ordens_servico_pecas[]
}

model celulares_historico {
  id               Int               @id @default(autoincrement())
  celular_id       Int
  ordem_servico_id Int?
  tipo_evento      TipoEventoCelular
  descricao        String            @db.Text
  data_evento      DateTime?         @default(now()) @db.Timestamptz(6)

  celular       celulares      @relation(fields: [celular_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  ordem_servico ordens_servico? @relation(fields: [ordem_servico_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
}

model ordens_servico_pecas {
  id               Int             @id @default(autoincrement())
  ordem_servico_id Int
  peca_id          Int
  quantidade       Int
  data_uso         DateTime?       @default(now()) @db.Timestamptz(6)

  ordem_servico ordens_servico @relation(fields: [ordem_servico_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  peca          pecas           @relation(fields: [peca_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([ordem_servico_id, peca_id], name: "ordem_servico_peca_unique")
}

enum TipoCliente {
  PF
  PJ
  CONSUMIDOR
  REVENDEDOR
  MANUTENCAO

  @@map("tipo_cliente")
}

enum TipoEstoqueCelular {
  Novo
  Usado
  Recondicionado

  @@map("tipo_estoque_celular")
}

enum StatusCelular {
  EmEstoque
  Vendido
  EmReparo
  Descartado

  @@map("status_celular")
}

enum StatusOrdemServico {
  EmAndamento
  Concluido

  @@map("status_ordem_servico")
}

enum TipoEventoCelular {
  OrdemServicoCriada
  OrdemServicoAtualizada
  OrdemServicoConcluida
  OrdemServicoPecaRegistrada
  GarantiaRegistrada
  GarantiaAlerta

  @@map("tipo_evento_celular")
}

model garantias {
  id              Int             @id @default(autoincrement())
  cliente_id      Int
  celular_id      Int
  origem_tipo     GarantiaOrigem
  origem_id       Int?
  tipo            TipoGarantia
  prazo_dias      Int
  data_inicio     DateTime        @db.Timestamptz(6)
  data_fim        DateTime        @db.Timestamptz(6)
  alerta_enviado_em DateTime?     @db.Timestamptz(6)
  observacoes     String?         @db.Text
  created_by      Int?            @default(1)
  updated_by      Int?            @default(1)
  created_at      DateTime?       @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?       @db.Timestamptz(6)

  cliente clientes @relation(fields: [cliente_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  celular celulares @relation(fields: [celular_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([origem_tipo, origem_id], name: "garantia_origem_unique")
}

enum GarantiaOrigem {
  VENDA
  ORDEM_SERVICO
  MANUAL

  @@map("garantia_origem")
}

enum TipoGarantia {
  PRODUTO
  SERVICO

  @@map("tipo_garantia")
}

model vendas {
  id               Int       @id @default(autoincrement())
  cliente_id       Int
  celular_id       Int
  data_venda       DateTime? @default(now()) @db.Timestamptz(6)
  valor_venda      Decimal?  @db.Decimal(10, 2)
  garantia_dias    Int?
  garantia_validade DateTime? @db.Timestamptz(6)
  observacoes      String?   @db.Text
  created_by       Int?      @default(1)
  updated_by       Int?      @default(1)
  updated_at       DateTime? @db.Timestamptz(6)

  cliente clientes @relation(fields: [cliente_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  celular celulares @relation(fields: [celular_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model movimentacoes_estoque {
  id              Int                        @id @default(autoincrement())
  tipo_item       TipoItemEstoque
  tipo_operacao   TipoMovimentacaoEstoque
  celular_id      Int?
  peca_id         Int?
  quantidade      Int
  saldo_resultante Int?
  observacoes     String?                   @db.Text
  data_movimentacao DateTime?               @default(now()) @db.Timestamptz(6)
  usuario_id      Int

  usuario usuarios @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  celular celulares? @relation(fields: [celular_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  peca     pecas?    @relation(fields: [peca_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([tipo_item], name: "movimentacoes_tipo_item_idx")
  @@index([tipo_operacao], name: "movimentacoes_tipo_operacao_idx")
  @@index([usuario_id], name: "movimentacoes_usuario_idx")
  @@index([data_movimentacao], name: "movimentacoes_data_idx")
}

enum TipoMovimentacaoEstoque {
  COMPRA
  VENDA
  DEVOLUCAO
  CONSERTO
}

enum TipoItemEstoque {
  CELULAR
  PECA
}